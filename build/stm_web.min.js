function SpeakToMe(e){function n(){r.vad&&!a&&(a=SpeakToMeVAD.SpeakToMeVAD());var e={audio:!0};navigator.mediaDevices.getUserMedia(e).then(t).catch(function(e){console.error(e)})}function t(e){function n(e){t()}function t(){e.getAudioTracks()[0].stop(),f.stop(),c.disconnect(d),c.disconnect(u),u.disconnect(l)}function i(){o({state:"processing"});var e=new Blob(p,{type:"audio/ogg; codecs=opus"});p=[],o({state:"sending"}),fetch(r.serverURL,{method:"POST",body:e}).then(function(e){return e.json()}).then(function(e){"ok"===e.status?o({state:"result",data:e.data}):console.error("Error parsing JSON response:",error)}).catch(function(e){console.error("Fetch error:",e)})}o({state:"listening"});var s=new AudioContext,c=s.createMediaStreamSource(e),u=s.createAnalyser(),l=s.createMediaStreamDestination();c.channelCount=1,u.channelCount=1,l.channelCount=1,c.connect(u),u.connect(l);var d;if(r.vad){d=s.createScriptProcessor(2048,1,1),d.onaudioprocess=a.onAudioProcessingEvent,a.setOnComplete(n),c.connect(d)}var v={audioBitsPerSecond:RECORDING_BITS_PER_SECOND,mimeType:RECORDING_MIME_TYPE},f=new MediaRecorder(l.stream,v);f.start(),r.vad||setTimeout(t,r.timeout),f.onstop=function(n){i(),f=null,s=null,c=null,u=null,l=null,e=null,d=null};var p=[];f.ondataavailable=function(e){p.push(e.data)}}function o(e){if(r.listener)try{r.listener(e)}catch(e){console.error("SpeakToMe: Listener error",e)}}var r={vad:!0,timeout:RECORDING_TIMEOUT,continuous:!1,serverURL:STT_SERVER_URL,listener:null};e&&(!1===e.vad&&(r.vad=!1),e.timeout&&(r.timeout=e.timeout),e.listener&&(r.listener=e.listener));var a=null;return{listen:n}}var STT_SERVER_URL="https://speaktome.services.mozilla.com",RECORDING_TIMEOUT=3e3,RECORDING_BITS_PER_SECOND=16e3,RECORDING_MIME_TYPE="audio/ogg";!function(){void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){var n=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return n?new Promise(function(t,o){n.call(navigator,e,t,o)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}(),"undefined"!=typeof module&&(module.exports=SpeakToMe);var SpeakToMeVAD=function(){function e(){function e(){u=new Int16Array(c),l=0,finishedvoice=!1,d=0,samplessilence=0,v=!1,f=!1,p=Date.now(),m=Date.now(),M=!1,h=!1}function n(e){var n=e.length*e.BYTES_PER_ELEMENT,t=Module._malloc(n),o=new Uint8Array(Module.HEAPU8.buffer,t,n);o.set(new Uint8Array(e.buffer));var r=s(o.byteOffset,e.length,48e3,e[0],e[100],e[2e3]);return Module._free(o.byteOffset),r}function t(e,n){for(var t=0;t<n.length;t++){var o=Math.max(-1,Math.min(1,n[t]));e[t]=o<0?32768*o:32767*o}}function o(e){var o=new Int16Array(e.inputBuffer.getChannelData(0).length);t(o,e.inputBuffer.getChannelData(0));for(var r=0;r<Math.ceil(o.length/c)&&!h;r++){var a=r*c,s=a+c;if(a+c>o.length)u.set(o.slice(a)),l=o.length-a;else{l>0?(s-=this.leftovers,u.set(o.slice(a,s),l),l=0):u.set(o.slice(a,s));var S=n(u);u=new Int16Array(c);var w=Date.now();0===S?v&&(samplessilence+=w-m,samplessilence>D&&(f=!0)):(d+=w-m)>g&&(v=!0),m=w,v&&f&&(finishedvoice=!0),finishedvoice&&(h=!0,i("finishedvoice")),(w-p)/1e3>E&&(h=!0,v?i("timeout"):(i("novoice"),M=!0))}}}function r(){console.warn("SpeakToMe_VAD: You need to set an onComplete callback via setOnComplete(yourfunc)")}function a(e){r=e}function i(n){try{r(n)}catch(e){console.log("SpeakToMe_VAD: onCompleteCallback exception",e)}e()}Module.cwrap("main")(),Module.cwrap("setmode","number",["number"])(3);var s=Module.cwrap("process_data","number",["number","number","number","number","number","number"]),c=480,u=new Int16Array(c),l=0,d=0,v=!1,f=!1,p=Date.now(),m=Date.now(),M=!1,h=!1,g=250,D=1500,E=6;return e(),{reset:e,onAudioProcessingEvent:o,setOnComplete:a}}return{SpeakToMeVAD:e}}(),Module={preRun:[],postRun:[],print:function(){return function(e){console.log("[webrtc_vad.js print]",e)}}(),printErr:function(e){console.error("[webrtc_vad.js error]",e)},canvas:void 0,setStatus:function(e){console.log("[webrtc_vad.js status] ",e)},totalDependencies:0,monitorRunDependencies:function(e){this.totalDependencies=Math.max(this.totalDependencies,e),Module.setStatus(e?"Preparing... ("+(this.totalDependencies-e)+"/"+this.totalDependencies+")":"All downloads complete.")}};Module.setStatus("Loading webrtc_vad..."),window.onerror=function(e){Module.setStatus("Exception thrown, see JavaScript console"),Module.setStatus=function(e){e&&Module.printErr("[post-exception status] "+e)}},Module.noInitialRun=!0,Module.onRuntimeInitialized=function(){Module.setStatus("Webrtc_vad and SpeakToMeVad loaded")};
