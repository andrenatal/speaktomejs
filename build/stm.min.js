!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,n.SpeakToMe=e()}}(function(){return function e(n,t,o){function r(a,s){if(!t[a]){if(!n[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var l=t[a]={exports:{}};n[a][0].call(l.exports,function(e){var t=n[a][1][e];return r(t||e)},l,l.exports,e,n,t,o)}return t[a].exports}for(var i="function"==typeof require&&require,a=0;a<o.length;a++)r(o[a]);return r}({1:[function(e,n,t){function o(e){function n(){c.vad&&!u&&(u=SpeakToMeVAD.SpeakToMeVAD());var e={audio:!0};navigator.mediaDevices.getUserMedia(e).then(t).catch(function(e){console.error(e)})}function t(e){function n(e){t()}function t(){e.getAudioTracks()[0].stop(),m.stop(),l.disconnect(p),l.disconnect(d),d.disconnect(f)}function r(){o({state:"processing"});var e=new Blob(h,{type:"audio/ogg; codecs=opus"});h=[],o({state:"sending"}),fetch(c.serverURL,{method:"POST",body:e}).then(function(e){return e.json()}).then(function(e){"ok"===e.status?o({state:"result",data:e.data}):console.error("Error parsing JSON response:",error)}).catch(function(e){console.error("Fetch error:",e)})}o({state:"listening"});var i=new AudioContext,l=i.createMediaStreamSource(e),d=i.createAnalyser(),f=i.createMediaStreamDestination();l.channelCount=1,d.channelCount=1,f.channelCount=1,l.connect(d),d.connect(f);var p;if(c.vad){p=i.createScriptProcessor(2048,1,1),p.onaudioprocess=u.onAudioProcessingEvent,u.setOnComplete(n),l.connect(p)}var v={audioBitsPerSecond:a,mimeType:s},m=new MediaRecorder(f.stream,v);m.start(),c.vad||setTimeout(t,c.timeout),m.onstop=function(n){r(),m=null,i=null,l=null,d=null,f=null,e=null,p=null};var h=[];m.ondataavailable=function(e){h.push(e.data)}}function o(e){if(c.listener)try{c.listener(e)}catch(e){console.error("SpeakToMe: Listener error",e)}}var c={vad:!0,timeout:i,continuous:!1,serverURL:r,listener:null};e&&(!1===e.vad&&(c.vad=!1),e.timeout&&(c.timeout=e.timeout),e.listener&&(c.listener=e.listener));var u=null;return{listen:n}}var r="https://speaktome.services.mozilla.com",i=3e3,a=16e3,s="audio/ogg";!function(){void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){var n=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return n?new Promise(function(t,o){n.call(navigator,e,t,o)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}(),void 0!==n&&(n.exports=o)},{}],2:[function(e,n,t){var o=(function(){function e(){function e(){l=new Int16Array(u),d=0,finishedvoice=!1,f=0,samplessilence=0,p=!1,v=!1,m=Date.now(),h=Date.now(),g=!1,w=!1}function n(e){var n=e.length*e.BYTES_PER_ELEMENT,t=o._malloc(n),r=new Uint8Array(o.HEAPU8.buffer,t,n);r.set(new Uint8Array(e.buffer));var i=c(r.byteOffset,e.length,48e3,e[0],e[100],e[2e3]);return o._free(r.byteOffset),i}function t(e,n){for(var t=0;t<n.length;t++){var o=Math.max(-1,Math.min(1,n[t]));e[t]=o<0?32768*o:32767*o}}function r(e){var o=new Int16Array(e.inputBuffer.getChannelData(0).length);t(o,e.inputBuffer.getChannelData(0));for(var r=0;r<Math.ceil(o.length/u)&&!w;r++){var i=r*u,a=i+u;if(i+u>o.length)l.set(o.slice(i)),d=o.length-i;else{d>0?(a-=this.leftovers,l.set(o.slice(i,a),d),d=0):l.set(o.slice(i,a));var c=n(l);l=new Int16Array(u);var M=Date.now();0===c?p&&(samplessilence+=M-h,samplessilence>D&&(v=!0)):(f+=M-h)>b&&(p=!0),h=M,p&&v&&(finishedvoice=!0),finishedvoice&&(w=!0,s("finishedvoice")),(M-m)/1e3>y&&(w=!0,p?s("timeout"):(s("novoice"),g=!0))}}}function i(){console.warn("SpeakToMe_VAD: You need to set an onComplete callback via setOnComplete(yourfunc)")}function a(e){i=e}function s(n){try{i(n)}catch(e){console.log("SpeakToMe_VAD: onCompleteCallback exception",e)}e()}o.cwrap("main")(),o.cwrap("setmode","number",["number"])(3);var c=o.cwrap("process_data","number",["number","number","number","number","number","number"]),u=480,l=new Int16Array(u),d=0,f=0,p=!1,v=!1,m=Date.now(),h=Date.now(),g=!1,w=!1,b=250,D=1500,y=6;return e(),{reset:e,onAudioProcessingEvent:r,setOnComplete:a}}}(),{preRun:[],postRun:[],print:function(){return function(e){console.log("[webrtc_vad.js print]",e)}}(),printErr:function(e){console.error("[webrtc_vad.js error]",e)},canvas:void 0,setStatus:function(e){console.log("[webrtc_vad.js status] ",e)},totalDependencies:0,monitorRunDependencies:function(e){this.totalDependencies=Math.max(this.totalDependencies,e),o.setStatus(e?"Preparing... ("+(this.totalDependencies-e)+"/"+this.totalDependencies+")":"All downloads complete.")}});o.setStatus("Loading webrtc_vad..."),window.onerror=function(e){o.setStatus("Exception thrown, see JavaScript console"),o.setStatus=function(e){e&&o.printErr("[post-exception status] "+e)}},o.noInitialRun=!0,o.onRuntimeInitialized=function(){o.setStatus("Webrtc_vad and SpeakToMeVad loaded")}},{}]},{},[1,2])(2)});
